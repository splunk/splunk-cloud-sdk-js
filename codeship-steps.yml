- type: parallel
  name: stubby
  steps:
    - name: stubby tests with coverage
      service: ssc-client-js-with-stubby
      command: bash -c "yarn run codecov"
    - type: serial
      name: integration
      steps:
      - name: initialize token fetcher service
        service: ssc-sdk-shared-token-fetcher
        command: true
      - name: create a tenant for CI
        service: ssc-sdk-shared-tenant-creation
        command: python /opt/splunk/ssc-sdk-shared/tenant-creation/tenant_creation.py
      - type: parallel
        name: integration tests & examples
        steps:
          - name: integration tests - not gated
            service: ssc-client-js-against-playground
            # exclude: ^(master|develop)$
            command: bash -c "allow_failures=1 ./ci/integration/runtests.sh"
          # - name: integration tests - gated
          #   service: ssc-client-js-against-playground
          #   tag: ^(master|develop)$
          #   command: bash -c "allow_failures=0 ./ci/integration/runtests.sh"
          # - name: run examples - gated
          #   service: ssc-client-js-against-playground
          #   tag: ^(master|develop)$
            # command: bash -c "allow_failures=0 ./ci/integration/runExamples.sh"
          - name: run examples - not gated
            service: ssc-client-js-against-playground
            exclude: ^(master|develop)$
            command: bash -c "allow_failures=1 ./ci/integration/runExamples.sh"
      - name: delete tenant that was created
        service: ssc-sdk-shared-tenant-creation
        command: python /opt/splunk/ssc-sdk-shared/tenant-creation/tenant_deletion.py
    - name: deploy
      service: ssc-client-js-with-stubby
      tag: master
      command: ./ci/publish.sh
